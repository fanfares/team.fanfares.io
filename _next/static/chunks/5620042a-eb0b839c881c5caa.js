"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[369],{7546:function(e,t,i){i.d(t,{ZP:function(){return eL},fJ:function(){return eN}});var s,r,n,a,o,h=i(3758),l=i(2206),c=i(5022),u=i(543),d=i(8104),p=i(3761),y=i(3803),f=i(1799);function g(e,t){if(e.outboxTracker)return e.outboxTracker.data.get(t)?.writeRelays}async function m(e,t,i){return t?new Promise((s,r)=>{let n=setTimeout(()=>{r(Error(i||`Timed out after ${t}ms`))},t);e().then(s,r).finally(()=>clearTimeout(n))}):e()}i(3321);var b=class{ndkRelay;_status;relay;timeoutMs;connectedAt;_connectionStats={attempts:0,success:0,durations:[]};debug;reconnectTimeout;constructor(e){this.ndkRelay=e,this._status=3,this.relay=(0,h.L6)(this.ndkRelay.url),this.debug=this.ndkRelay.debug.extend("connectivity"),this.relay.on("notice",e=>this.handleNotice(e))}async connect(e,t=!0){this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),e??=this.timeoutMs,!this.timeoutMs&&e&&(this.timeoutMs=e);let i=()=>{this.updateConnectionStats.connected(),this._status=1,this.ndkRelay.emit("connect"),this.ndkRelay.emit("ready")},s=()=>{this.updateConnectionStats.disconnected(),1===this._status&&(this._status=3,this.handleReconnection()),this.ndkRelay.emit("disconnect")},r=async e=>{this.debug("Relay requested authentication",{havePolicy:!!this.ndkRelay.authPolicy}),this.ndkRelay.authPolicy?7!==this._status&&(this._status=7,await this.ndkRelay.authPolicy(this.ndkRelay,e),7===this._status&&(this.debug("Authentication policy finished"),this._status=1,this.ndkRelay.emit("authed"))):await this.ndkRelay.emit("auth",e)};try{this.updateConnectionStats.attempt(),3===this._status?this._status=0:this._status=4,this.relay.off("connect",i),this.relay.off("disconnect",s),this.relay.on("connect",i),this.relay.on("disconnect",s),this.relay.on("auth",r),await m(this.relay.connect,e,"Timed out while connecting")}catch(e){throw this._status=3,t?this.handleReconnection():this.ndkRelay.emit("delayed-connect",1728e5),e}}disconnect(){this._status=2,this.relay.close()}get status(){return this._status}isAvailable(){return 1===this._status}isFlapping(){let e=this._connectionStats.durations;if(e.length%3!=0)return!1;let t=e.reduce((e,t)=>e+t,0)/e.length;return 1e3>Math.sqrt(e.map(e=>Math.pow(e-t,2)).reduce((e,t)=>e+t,0)/e.length)}async handleNotice(e){(e.includes("oo many")||e.includes("aximum"))&&(this.disconnect(),setTimeout(()=>this.connect(),2e3),this.debug(this.relay.url,"Relay complaining?",e)),this.ndkRelay.emit("notice",e)}handleReconnection(e=0){if(this.reconnectTimeout)return;if(this.debug("Attempting to reconnect",{attempt:e}),this.isFlapping()){this.ndkRelay.emit("flapping",this._connectionStats),this._status=5;return}let t=this.connectedAt?Math.max(0,6e4-(Date.now()-this.connectedAt)):5e3*(this._connectionStats.attempts+1);this.reconnectTimeout=setTimeout(()=>{this.reconnectTimeout=void 0,this._status=4,this.connect().then(()=>{this.debug("Reconnected")}).catch(t=>{e<5?setTimeout(()=>{this.handleReconnection(e+1)},1e3*(e+1)^4):this.debug("Reconnect failed")})},t),this.ndkRelay.emit("delayed-connect",t),this.debug("Reconnecting in",t),this._connectionStats.nextReconnectAt=Date.now()+t}updateConnectionStats={connected:()=>{this._connectionStats.success++,this._connectionStats.connectedAt=Date.now()},disconnected:()=>{this._connectionStats.connectedAt&&(this._connectionStats.durations.push(Date.now()-this._connectionStats.connectedAt),this._connectionStats.durations.length>100&&this._connectionStats.durations.shift()),this._connectionStats.connectedAt=void 0},attempt:()=>{this._connectionStats.attempts++}};get connectionStats(){return this._connectionStats}},k=class{ndkRelay;constructor(e){this.ndkRelay=e}async publish(e,t=2500){let i,s;let r=()=>new Promise((i,s)=>{try{this.publishEvent(e,t).then(e=>i(e)).catch(e=>s(e))}catch(e){s(e)}}),n=new Promise((e,i)=>{setTimeout(()=>i(Error("Timeout")),t)}),a=()=>{r().then(e=>i(e)).catch(e=>s(e))};return 1===this.ndkRelay.status?Promise.race([r(),n]):Promise.race([new Promise((e,t)=>{i=e,s=t,this.ndkRelay.once("connect",a)}),n]).finally(()=>{this.ndkRelay.removeListener("connect",a)})}async publishEvent(e,t){let i;let s=await e.toNostrEvent(),r=this.ndkRelay.connectivity.relay.publish(s),n=new Promise((t,s)=>{r.then(()=>{clearTimeout(i),this.ndkRelay.emit("published",e),t(!0)}).catch(t=>{clearTimeout(i),this.ndkRelay.debug("Publish failed",t,e.id),this.ndkRelay.emit("publish:failed",e,t),s(t)})});return!t||e.isEphemeral()?n:Promise.race([n,new Promise((s,r)=>{i=setTimeout(()=>{this.ndkRelay.debug("Publish timed out",e.rawEvent()),this.ndkRelay.emit("publish:failed",e,"Timeout"),r(Error("Publish operation timed out"))},t)})])}async auth(e){return this.ndkRelay.connectivity.relay.auth(e.rawEvent())}};function w(e){return!!(e.filter.ids&&function(e){let t=e.filter.ids;return!!t&&t.length===e.eventFirstSeen.size}(e))}var v=/^(\d+):([0-9A-Fa-f]+)(?::(.*))?$/,R=/^n(event|ote|profile|pub|addr)1[\d\w]+$/,E=class extends l.EventEmitter{subscriptions;req;debug;constructor(e,t){for(let i of(super(),this.subscriptions=e,this.debug=t||this.subscriptions[0].subscription.debug.extend("grouped"),e))this.handleSubscriptionClosure(i)}addSubscription(e){this.subscriptions.push(e),this.handleSubscriptionClosure(e)}eventReceived(e){for(let t of this.subscriptions)t.eventReceived(e)}eoseReceived(e){Array.from(this.subscriptions).forEach(async t=>{t.subscription.eoseReceived(e)})}handleSubscriptionClosure(e){e.subscription.on("close",()=>{let t=this.subscriptions.findIndex(t=>t.subscription===e.subscription);this.subscriptions.splice(t,1),this.subscriptions.length<=0&&this.emit("close")})}map(e){return this.subscriptions.map(e)}[Symbol.iterator](){let e=0,t=this.subscriptions;return{next:()=>e<t.length?{value:t[e++],done:!1}:{value:null,done:!0}}}},S=class{subscription;filters=[];ndkRelay;constructor(e,t,i){this.subscription=e,this.filters=t,this.ndkRelay=i}eventReceived(e){if(!this.eventMatchesLocalFilter(e))return;let t=new eo(void 0,e);t.relay=this.ndkRelay,this.subscription.eventReceived(t,this.ndkRelay,!1)}eventMatchesLocalFilter(e){return this.filters.some(t=>(0,h.ex)(t,e))}},T=class{ndkRelay;delayedItems=new Map;delayedTimers=new Map;activeSubscriptions=new Map;activeSubscriptionsByGroupId=new Map;executionTimeoutsByGroupId=new Map;debug;groupingDebug;conn;constructor(e){this.ndkRelay=e,this.conn=e.connectivity,this.debug=e.debug.extend("subscriptions"),this.groupingDebug=e.debug.extend("grouping")}subscribe(e,t){let i=function(e,t){let i=[];for(let t of e){if(t.since||t.until)return null;let e=Object.keys(t||{}).sort().join("-");i.push(e)}return(t?"+":"")+i.join("|")}(t,e.closeOnEose),s=new S(e,t,this.ndkRelay);if(!i||!e.isGroupable()){this.executeSubscriptions(i,new E([s]),t);return}let r=this.activeSubscriptionsByGroupId.get(i);if(r&&function(e,t){if(e.length!==t.length)return!1;for(let i=0;i<e.length&&function(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(let[i,s]of Object.entries(e)){let e=t[i];if(!e)return!1;if(Array.isArray(s)&&Array.isArray(e)){for(let t of e)if(!s.includes(t))return!1}else if(e!==s)return!1}return!0}(e[i],t[i]);i++)return e[i]}(r.filters,t)){let i=this.activeSubscriptions.get(r.sub);i?.addSubscription(new S(e,t,this.ndkRelay));return}let n=this.delayedItems.get(i);n?n.addSubscription(s):(n=new E([s]),this.delayedItems.set(i,n),n.once("close",()=>{this.delayedItems.get(i)&&this.delayedItems.delete(i)}));let a=this.executionTimeoutsByGroupId.get(i);a&&"at-most"!==e.opts.groupableDelayType||(a=setTimeout(()=>{this.executeGroup(i,e)},e.opts.groupableDelay),this.executionTimeoutsByGroupId.set(i,a)),this.delayedTimers.has(i)?this.delayedTimers.get(i).push(a):this.delayedTimers.set(i,[a])}executeGroup(e,t){let i=this.delayedItems.get(e);this.delayedItems.delete(e);let s=this.delayedTimers.get(e);if(this.delayedTimers.delete(e),s)for(let e of s)clearTimeout(e);if(i){let t=i.subscriptions[0].filters.length,s=[];for(let e=0;e<t;e++){let t=i.map(t=>t.filters[e]);s.push(function(e){let t={};return e.forEach(e=>{Object.entries(e).forEach(([e,i])=>{Array.isArray(i)?void 0===t[e]?t[e]=[...i]:t[e]=Array.from(new Set([...t[e],...i])):t[e]=i})}),t}(t))}this.executeSubscriptions(e,i,s)}}executeSubscriptionsWhenConnected(e,t,i){let s=()=>{this.executeSubscriptionsConnected(e,t,i)};this.ndkRelay.once("ready",s),t.once("close",()=>{this.ndkRelay.removeListener("ready",s)})}executeSubscriptions(e,t,i){this.conn.isAvailable()?this.executeSubscriptionsConnected(e,t,i):this.executeSubscriptionsWhenConnected(e,t,i)}executeSubscriptionsConnected(e,t,i){let s=[];for(let{subscription:e}of t)s.push(e);let r=function(e,t){let i=e.map(e=>e.subId).filter(Boolean),s=[],r=new Set,n=new Set;if(i.length>0)s.push(Array.from(new Set(i)).join(","));else{for(let e of t)for(let t of Object.keys(e))"kinds"===t?e.kinds?.forEach(e=>n.add(e)):r.add(t);n.size>0&&s.push("kinds:"+Array.from(n).join(",")),r.size>0&&s.push(Array.from(r).join(","))}let a=s.join("-");return a.length>20&&(a=a.substring(0,20)),a+="-"+Math.floor(999*Math.random()).toString()}(s,i);t.req=i;let n={id:r};n.skipVerification=!0;let a=this.conn.relay.sub(i,n);return this.activeSubscriptions.set(a,t),e&&this.activeSubscriptionsByGroupId.set(e,{filters:i,sub:a}),a.on("event",e=>{let t=this.activeSubscriptions.get(a);t?.eventReceived(e)}),a.on("eose",()=>{let e=this.activeSubscriptions.get(a);e?.eoseReceived(this.ndkRelay)}),t.once("close",()=>{a.unsub(),this.activeSubscriptions.delete(a),e&&this.activeSubscriptionsByGroupId.delete(e)}),this.executeSubscriptionsWhenConnected(e,t,i),a}executedFilters(){let e=new Map;for(let[,t]of this.activeSubscriptions)e.set(t.req,t.map(e=>e.subscription));return e}},A=(e,t)=>t.some(t=>t instanceof RegExp?t.test(e):t===e),N=new Set(["https:","http:","file:"]),P=e=>{try{let{protocol:t}=new URL(e);return t.endsWith(":")&&!t.includes(".")&&!N.has(t)}catch{return!1}},C=(e,{stripHash:t})=>{let i=/^data:(?<type>[^,]*?),(?<data>[^#]*?)(?:#(?<hash>.*))?$/.exec(e);if(!i)throw Error(`Invalid URL: ${e}`);let{type:s,data:r,hash:n}=i.groups,a=s.split(";");n=t?"":n;let o=!1;"base64"===a[a.length-1]&&(a.pop(),o=!0);let h=a.shift()?.toLowerCase()??"",l=[...a.map(e=>{let[t,i=""]=e.split("=").map(e=>e.trim());return"charset"===t&&"us-ascii"===(i=i.toLowerCase())?"":`${t}${i?`=${i}`:""}`}).filter(Boolean)];return o&&l.push("base64"),(l.length>0||h&&"text/plain"!==h)&&l.unshift(h),`data:${l.join(";")},${o?r.trim():r}${n?`#${n}`:""}`};function U(e){let t=function(e,t){if("string"!=typeof(t={defaultProtocol:"http",normalizeProtocol:!0,forceHttp:!1,forceHttps:!1,stripAuthentication:!0,stripHash:!1,stripTextFragment:!0,stripWWW:!0,removeQueryParameters:[/^utm_\w+/i],removeTrailingSlash:!0,removeSingleSlash:!0,removeDirectoryIndex:!1,removeExplicitPort:!1,sortQueryParameters:!0,...t}).defaultProtocol||t.defaultProtocol.endsWith(":")||(t.defaultProtocol=`${t.defaultProtocol}:`),e=e.trim(),/^data:/i.test(e))return C(e,t);if(P(e))return e;let i=e.startsWith("//");!i&&/^\.*\//.test(e)||(e=e.replace(/^(?!(?:\w+:)?\/\/)|^\/\//,t.defaultProtocol));let s=new URL(e);if(t.forceHttp&&t.forceHttps)throw Error("The `forceHttp` and `forceHttps` options cannot be used together");if(t.forceHttp&&"https:"===s.protocol&&(s.protocol="http:"),t.forceHttps&&"http:"===s.protocol&&(s.protocol="https:"),t.stripAuthentication&&(s.username="",s.password=""),t.stripHash?s.hash="":t.stripTextFragment&&(s.hash=s.hash.replace(/#?:~:text.*?$/i,"")),s.pathname){let e=/\b[a-z][a-z\d+\-.]{1,50}:\/\//g,t=0,i="";for(;;){let r=e.exec(s.pathname);if(!r)break;let n=r[0],a=r.index;i+=s.pathname.slice(t,a).replace(/\/{2,}/g,"/")+n,t=a+n.length}i+=s.pathname.slice(t,s.pathname.length).replace(/\/{2,}/g,"/"),s.pathname=i}if(s.pathname)try{s.pathname=decodeURI(s.pathname)}catch{}if(!0===t.removeDirectoryIndex&&(t.removeDirectoryIndex=[/^index\.[a-z]+$/]),Array.isArray(t.removeDirectoryIndex)&&t.removeDirectoryIndex.length>0){let e=s.pathname.split("/");A(e[e.length-1],t.removeDirectoryIndex)&&(e=e.slice(0,-1),s.pathname=e.slice(1).join("/")+"/")}if(s.hostname&&(s.hostname=s.hostname.replace(/\.$/,""),t.stripWWW&&/^www\.(?!www\.)[a-z\-\d]{1,63}\.[a-z.\-\d]{2,63}$/.test(s.hostname)&&(s.hostname=s.hostname.replace(/^www\./,""))),Array.isArray(t.removeQueryParameters))for(let e of[...s.searchParams.keys()])A(e,t.removeQueryParameters)&&s.searchParams.delete(e);if(Array.isArray(t.keepQueryParameters)||!0!==t.removeQueryParameters||(s.search=""),Array.isArray(t.keepQueryParameters)&&t.keepQueryParameters.length>0)for(let e of[...s.searchParams.keys()])A(e,t.keepQueryParameters)||s.searchParams.delete(e);if(t.sortQueryParameters){s.searchParams.sort();try{s.search=decodeURIComponent(s.search)}catch{}}t.removeTrailingSlash&&(s.pathname=s.pathname.replace(/\/$/,"")),t.removeExplicitPort&&s.port&&(s.port="");let r=e;return e=s.toString(),t.removeSingleSlash||"/"!==s.pathname||r.endsWith("/")||""!==s.hash||(e=e.replace(/\/$/,"")),(t.removeTrailingSlash||"/"===s.pathname)&&""===s.hash&&t.removeSingleSlash&&(e=e.replace(/\/$/,"")),i&&!t.normalizeProtocol&&(e=e.replace(/^http:\/\//,"//")),t.stripProtocol&&(e=e.replace(/^(?:https?:)?\/\//,"")),e}(e.toLowerCase(),{stripAuthentication:!1,stripWWW:!1,stripHash:!0});return t.endsWith("/")||(t+="/"),t}function _(e){let t=new Set;for(let i of e)try{t.add(U(i))}catch{}return Array.from(t)}var x=((s=x||{})[s.CONNECTING=0]="CONNECTING",s[s.CONNECTED=1]="CONNECTED",s[s.DISCONNECTING=2]="DISCONNECTING",s[s.DISCONNECTED=3]="DISCONNECTED",s[s.RECONNECTING=4]="RECONNECTING",s[s.FLAPPING=5]="FLAPPING",s[s.AUTH_REQUIRED=6]="AUTH_REQUIRED",s[s.AUTHENTICATING=7]="AUTHENTICATING",s),D=class extends l.EventEmitter{url;scores;connectivity;subs;publisher;authPolicy;validationRatio;validatedEventCount=0;skippedEventCount=0;trusted=!1;complaining=!1;debug;constructor(e,t){super(),this.url=U(e),this.scores=new Map,this.debug=c(`ndk:relay:${e}`),this.connectivity=new b(this),this.subs=new T(this),this.publisher=new k(this),this.authPolicy=t,this.validationRatio=void 0}get status(){return this.connectivity.status}get connectionStats(){return this.connectivity.connectionStats}async connect(e,t=!0){return this.connectivity.connect(e,t)}disconnect(){3!==this.status&&this.connectivity.disconnect()}subscribe(e,t){this.subs.subscribe(e,t)}async publish(e,t=2500){return this.publisher.publish(e,t)}async auth(e){return this.publisher.auth(e)}scoreSlowerEvent(e){}tagReference(e){let t=["r",this.url];return e&&t.push(e),t}referenceTags(){return[["r",this.url]]}activeSubscriptions(){return this.subs.executedFilters()}addValidatedEvent(){this.validatedEventCount++}addSkippedEvent(){this.skippedEventCount++}getValidationRatio(){return 0===this.skippedEventCount?1:this.validatedEventCount/(this.validatedEventCount+this.skippedEventCount)}shouldValidateEvent(){return!this.trusted&&(void 0===this.validationRatio||this.getValidationRatio()<this.validationRatio)}},M=class extends Error{errors;constructor(e,t){super(e),this.errors=t}get relayErrors(){let e=[];for(let[t,i]of this.errors)e.push(`${t.url}: ${i}`);return e.join("\n")}},I=class e{relays;debug;ndk;constructor(e,t){this.relays=e,this.ndk=t,this.debug=t.debug.extend("relayset")}addRelay(e){this.relays.add(e)}static fromRelayUrls(t,i){let s=new Set;for(let e of t){let t=i.pool.relays.get(e);if(t)s.add(t);else{let t=new D(e);i.pool.useTemporaryRelay(t),s.add(t)}}return new e(new Set(s),i)}async publish(e,t){let i=new Set,s=new Map,r=e.isEphemeral(),n=Array.from(this.relays).map(n=>new Promise(a=>{n.publish(e,t).then(e=>{i.add(n),a()}).catch(e=>{r||(s.set(n,e),this.debug("error publishing to relay",{relay:n.url,err:e})),a()})}));if(await Promise.all(n),0===i.size&&!r)throw new M("No relay was able to receive the event",s);return i}get size(){return this.relays.size}};async function z(e,t=[]){let i=[],s=e=>{t.find(t=>["q",e[0]].includes(t[0])&&t[1]===e[1])||t.push(e)};return e=e.replace(/(@|nostr:)(npub|nprofile|note|nevent|naddr)[a-zA-Z0-9]+/g,e=>{try{let t;let r=e.split(/(@|nostr:)/)[2],{type:n,data:a}=h.uD.decode(r);switch(n){case"npub":t=["p",a];break;case"nprofile":t=["p",a.pubkey];break;case"note":i.push(new Promise(async e=>{s(["e",a,await L(r),"mention"]),e()}));break;case"nevent":i.push(new Promise(async e=>{let{id:t,relays:i,author:n}=a;i&&0!==i.length||(i=[await L(r)]),s(["e",t,i[0],"mention"]),n&&s(["p",n]),e()}));break;case"naddr":i.push(new Promise(async e=>{let t=[a.kind,a.pubkey,a.identifier].join(":"),i=a.relays??[];0===i.length&&(i=[await L(r)]),s(["a",t,i[0],"mention"]),s(["p",a.pubkey]),e()}));break;default:return e}return t&&s(t),`nostr:${r}`}catch(t){return e}}),await Promise.all(i),{content:e=e.replace(/(?<=\s|^)(#[^\s!@#$%^&*()=+.\/,\[{\]};:'"?><]+)/g,(e,i)=>{let s=["t",i];return t.find(e=>e[0]===s[0]&&e[1]===s[1])||t.push(s),e}),tags:t}}async function L(e){return""}function F(){if(void 0===this.kind)throw Error("Kind not set");return[0,3].includes(this.kind)||this.kind>=1e4&&this.kind<2e4||this.kind>=3e4&&this.kind<4e4}function $(){if(void 0===this.kind)throw Error("Kind not set");return this.kind>=2e4&&this.kind<3e4}function O(){if(void 0===this.kind)throw Error("Kind not set");return this.kind>=3e4&&this.kind<4e4}var q=((r=q||{})[r.Metadata=0]="Metadata",r[r.Text=1]="Text",r[r.RecommendRelay=2]="RecommendRelay",r[r.Contacts=3]="Contacts",r[r.EncryptedDirectMessage=4]="EncryptedDirectMessage",r[r.EventDeletion=5]="EventDeletion",r[r.Repost=6]="Repost",r[r.Reaction=7]="Reaction",r[r.BadgeAward=8]="BadgeAward",r[r.GroupChat=9]="GroupChat",r[r.GroupNote=11]="GroupNote",r[r.GroupReply=12]="GroupReply",r[r.GenericRepost=16]="GenericRepost",r[r.ChannelCreation=40]="ChannelCreation",r[r.ChannelMetadata=41]="ChannelMetadata",r[r.ChannelMessage=42]="ChannelMessage",r[r.ChannelHideMessage=43]="ChannelHideMessage",r[r.ChannelMuteUser=44]="ChannelMuteUser",r[r.Media=1063]="Media",r[r.Report=1984]="Report",r[r.Label=1985]="Label",r[r.DVMReqTextExtraction=5e3]="DVMReqTextExtraction",r[r.DVMReqTextSummarization=5001]="DVMReqTextSummarization",r[r.DVMReqTextTranslation=5002]="DVMReqTextTranslation",r[r.DVMReqTextGeneration=5050]="DVMReqTextGeneration",r[r.DVMReqImageGeneration=5100]="DVMReqImageGeneration",r[r.DVMReqDiscoveryNostrContent=5300]="DVMReqDiscoveryNostrContent",r[r.DVMReqDiscoveryNostrPeople=5301]="DVMReqDiscoveryNostrPeople",r[r.DVMReqTimestamping=5900]="DVMReqTimestamping",r[r.DVMEventSchedule=5905]="DVMEventSchedule",r[r.DVMJobFeedback=7e3]="DVMJobFeedback",r[r.Subscribe=7001]="Subscribe",r[r.Unsubscribe=7002]="Unsubscribe",r[r.SubscriptionReceipt=7003]="SubscriptionReceipt",r[r.GroupAdminAddUser=9e3]="GroupAdminAddUser",r[r.GroupAdminRemoveUser=9001]="GroupAdminRemoveUser",r[r.GroupAdminEditMetadata=9002]="GroupAdminEditMetadata",r[r.GroupAdminEditStatus=9006]="GroupAdminEditStatus",r[r.MuteList=1e4]="MuteList",r[r.PinList=10001]="PinList",r[r.RelayList=10002]="RelayList",r[r.BookmarkList=10003]="BookmarkList",r[r.CommunityList=10004]="CommunityList",r[r.PublicChatList=10005]="PublicChatList",r[r.BlockRelayList=10006]="BlockRelayList",r[r.SearchRelayList=10007]="SearchRelayList",r[r.SimpleGroupList=10009]="SimpleGroupList",r[r.InterestList=10015]="InterestList",r[r.EmojiList=10030]="EmojiList",r[r.BlossomList=10063]="BlossomList",r[r.NostrWaletConnectInfo=13194]="NostrWaletConnectInfo",r[r.TierList=17e3]="TierList",r[r.FollowSet=3e4]="FollowSet",r[r.CategorizedPeopleList=3e4]="CategorizedPeopleList",r[r.CategorizedBookmarkList=30001]="CategorizedBookmarkList",r[r.RelaySet=30002]="RelaySet",r[r.CategorizedRelayList=30002]="CategorizedRelayList",r[r.BookmarkSet=30003]="BookmarkSet",r[r.CurationSet=30004]="CurationSet",r[r.ArticleCurationSet=30004]="ArticleCurationSet",r[r.VideoCurationSet=30005]="VideoCurationSet",r[r.InterestSet=30015]="InterestSet",r[r.InterestsList=30015]="InterestsList",r[r.EmojiSet=30030]="EmojiSet",r[r.HighlightSet=39802]="HighlightSet",r[r.SubscriptionTier=37001]="SubscriptionTier",r[r.CategorizedHighlightList=39802]="CategorizedHighlightList",r[r.ZapRequest=9734]="ZapRequest",r[r.Zap=9735]="Zap",r[r.Highlight=9802]="Highlight",r[r.ClientAuth=22242]="ClientAuth",r[r.NostrWalletConnectReq=23194]="NostrWalletConnectReq",r[r.NostrWalletConnectRes=23195]="NostrWalletConnectRes",r[r.NostrConnect=24133]="NostrConnect",r[r.HttpAuth=27235]="HttpAuth",r[r.ProfileBadge=30008]="ProfileBadge",r[r.BadgeDefinition=30009]="BadgeDefinition",r[r.MarketStall=30017]="MarketStall",r[r.MarketProduct=30018]="MarketProduct",r[r.Article=30023]="Article",r[r.AppSpecificData=30078]="AppSpecificData",r[r.Classified=30402]="Classified",r[r.HorizontalVideo=34235]="HorizontalVideo",r[r.GroupMetadata=39e3]="GroupMetadata",r[r.GroupMembers=39002]="GroupMembers",r[r.AppRecommendation=31989]="AppRecommendation",r[r.AppHandler=31990]="AppHandler",r);async function V(e,t){if(!this.ndk)throw Error("No NDK instance found!");if(t||(await this.ndk.assertSigner(),t=this.ndk.signer),!e){let t=this.getMatchingTags("p");if(1!==t.length)throw Error("No recipient could be determined and no explicit recipient was provided");e=this.ndk.getUser({pubkey:t[0][1]})}this.content=await t?.encrypt(e,this.content)}async function G(e,t){if(!this.ndk)throw Error("No NDK instance found!");t||(await this.ndk.assertSigner(),t=this.ndk.signer),e||(e=this.author),this.content=await t?.decrypt(e,this.content)}function H(){let e=[];return(this.onRelays.length>0?e=this.onRelays.map(e=>e.url):this.relay&&(e=[this.relay.url]),this.isParamReplaceable())?h.uD.naddrEncode({kind:this.kind,pubkey:this.pubkey,identifier:this.replaceableDTag(),relays:e}):e.length>0?h.uD.neventEncode({id:this.tagId(),relays:e,author:this.pubkey}):h.uD.noteEncode(this.tagId())}async function K(e=!0,t){if(!t&&e){if(!this.ndk)throw Error("No NDK instance found");this.ndk.assertSigner(),t=this.ndk.signer}let i=new eo(this.ndk,{kind:1===this.kind?6:16,content:""});return i.tag(this),16===i.kind?i.tags.push(["k",`${this.kind}`]):i.content=JSON.stringify(this.rawEvent()),t&&await i.sign(t),e&&await i.publish(),i}function W(e){return e.getMatchingTags("e").some(e=>e[3])}async function j(e,t){let i;if(!this.ndk)throw Error("NDK instance not found");let s=this.getMatchingTags(e,t);if(0===s.length)return;let[r,n,a]=s[0];return await this.ndk.fetchEvent(n,{},i)}async function B(){if(!this.ndk)throw Error("NDK instance not found");let e=function(e,t){t??=e.tagType();let i=e.tags.find(e=>"root"===e[3]);if(!i){if(W(e))return;let i=e.getMatchingTags(t);if(i.length<3)return i[0]}return i}(this);if(e)return this.ndk.fetchEventFromTag(e)}async function Z(){if(!this.ndk)throw Error("NDK instance not found");let e=function(e,t){t??=e.tagType();let i=e.tags.find(e=>"reply"===e[3]);if(i)return i;if(i||(i=e.tags.find(e=>"root"===e[3])),!i){if(W(e))return;let i=e.getMatchingTags(t);if(1===i.length)return i[0];if(2===i.length)return i[1]}}(this);if(e)return this.ndk.fetchEventFromTag(e)}function J(e=!1,t=!1){let i=[0,this.pubkey,this.created_at,this.kind,this.tags,this.content];return e&&i.push(this.sig),t&&i.push(this.id),JSON.stringify(i)}var Q={};async function Y(e,t){return new Promise(t=>{let i=e.serialize(),s=!1;Q[e.id]||(Q[e.id]={event:e,resolves:[]},s=!0),Q[e.id].resolves.push(t),s&&o.postMessage({serialized:i,id:e.id,sig:e.sig,pubkey:e.pubkey})})}var X=/^[a-f0-9]{64}$/;function ee(){if("number"!=typeof this.kind||"string"!=typeof this.content||"number"!=typeof this.created_at||"string"!=typeof this.pubkey||!this.pubkey.match(X)||!Array.isArray(this.tags))return!1;for(let e=0;e<this.tags.length;e++){let t=this.tags[e];if(!Array.isArray(t))return!1;for(let e=0;e<t.length;e++)if("object"==typeof t[e])return!1}return!0}var et=new y.LRUCache({maxSize:1e3,entryExpirationTimeInMS:6e4});function ei(e){if("boolean"==typeof this.signatureVerified)return this.signatureVerified;let t=et.get(this.id);if(null!==t)return this.signatureVerified=t;try{if(this.ndk?.asyncSigVerification)Y(this,e).then(t=>{e&&(this.signatureVerified=t,et.set(this.id,t)),t||this.ndk.emit("event:invalid-sig",this)});else{let e=(0,u.J)(new TextEncoder().encode(this.serialize())),t=p.xW.verify(this.sig,e,this.pubkey);return et.set(this.id,t),this.signatureVerified=t}}catch(e){return console.error("Error verifying signature",this.rawEvent(),e),this.signatureVerified=!1}}function es(){return function(e){let t=(0,u.J)(new TextEncoder().encode(e));return(0,d.ci)(t)}(this.serialize())}var er=c("ndk:zap"),en=["wss://nos.lol","wss://relay.nostr.band","wss://relay.f7z.io","wss://relay.damus.io","wss://nostr.mom","wss://no.str.cr"],ea=class e extends l.EventEmitter{ndk;zappedEvent;zappedUser;fetch=fetch;constructor(e){super(),this.ndk=e.ndk,this.zappedEvent=e.zappedEvent,this.fetch=e._fetch||fetch,this.zappedUser=e.zappedUser||this.ndk.getUser({pubkey:this.zappedEvent?.pubkey})}static async getZapperPubkey(t,i){let s=t.getUser({pubkey:i}),r=new e({ndk:t,zappedUser:s}),n=await r.getZapSpec();return n?.nostrPubkey}async getZapSpec(){if(!this.zappedUser)throw Error("No user to zap was provided");return this.zappedUser.getZapConfiguration(this.ndk)}async getZapSpecWithoutCache(){let e,t,i,s;if(this.zappedUser&&(this.zappedUser.profile||await this.zappedUser.fetchProfile({groupable:!1}),s=this.zappedUser.profile,e=(this.zappedUser.profile||{}).lud06,t=(this.zappedUser.profile||{}).lud16),t&&!t.startsWith("LNURL")){let[e,s]=t.split("@");i=`https://${s}/.well-known/lnurlp/${e}`}else if(e){let{words:t}=f.gW.decode(e,1e3),s=f.gW.fromWords(t);i=new TextDecoder("utf-8").decode(s)}if(!i)throw er("No zap endpoint found",s,{lud06:e,lud16:t}),Error("No zap endpoint found");try{let e=this.fetch||this.ndk.httpFetch,t=await e(i);if(200!==t.status){let e=await t.text();throw Error(`Unable to fetch zap endpoint ${i}: ${e}`)}return await t.json()}catch(e){throw Error(`Unable to fetch zap endpoint ${i}: ${e}`)}}async getZapEndpoint(){let e;let t=await this.getZapSpec();if(t)return t?.allowsNostr&&(t?.nostrPubkey||t?.nostrPubkey)&&(e=t.callback),e}async createZapRequest(e,t,i,s,r){let n;let a=await this.generateZapRequest(e,t,i,s);if(!a)return null;let{event:o,zapEndpoint:h}=a;if(!o)throw Error("No zap request event found");await o.sign(r);try{er(`Getting invoice for zap request: ${h}`),n=await this.getInvoice(o,e,h)}catch(e){throw Error("Failed to get invoice: "+e)}return n}async getInvoice(e,t,i){er(`Fetching invoice from ${i}?`+new URLSearchParams({amount:t.toString(),nostr:encodeURIComponent(JSON.stringify(e.rawEvent()))}));let s=new URL(i);s.searchParams.append("amount",t.toString()),s.searchParams.append("nostr",JSON.stringify(e.rawEvent())),er(`Fetching invoice from ${s.toString()}`);let r=await fetch(s.toString());if(er(`Got response from zap endpoint: ${i}`,{status:r.status}),200!==r.status){er(`Received non-200 status from zap endpoint: ${i}`,{status:r.status,amount:t,nostr:JSON.stringify(e.rawEvent())});let s=await r.text();throw Error(`Unable to fetch zap endpoint ${i}: ${s}`)}return(await r.json()).pr}async generateZapRequest(e,t,i,s,r){let n=await this.getZapEndpoint();if(!n)throw Error("No zap endpoint found");if(!this.zappedEvent&&!this.zappedUser)throw Error("No zapped event or user found");let a=h.cy.makeZapRequest({profile:this.zappedUser.pubkey,event:null,amount:e,comment:t||"",relays:s??this.relays()});if(this.zappedEvent){let e=this.zappedEvent.referenceTags().filter(e=>"p"!==e[0]);a.tags.push(...e)}a.tags.push(["lnurl",n]);let o=new eo(this.ndk,a);return i&&(o.tags=o.tags.concat(i)),{event:o,zapEndpoint:n}}relays(){let e=[];return this.ndk?.pool?.relays&&(e=this.ndk.pool.urls()),e.length||(e=en),e}},eo=class e extends l.EventEmitter{ndk;created_at;content="";tags=[];kind;id="";sig;pubkey="";signatureVerified;_author=void 0;relay;onRelays=[];constructor(e,t){super(),this.ndk=e,this.created_at=t?.created_at,this.content=t?.content||"",this.tags=t?.tags||[],this.id=t?.id||"",this.sig=t?.sig,this.pubkey=t?.pubkey||"",this.kind=t?.kind}static deserialize(t,i){return new e(t,function(e){let t=JSON.parse(e),i={pubkey:t[1],created_at:t[2],kind:t[3],tags:t[4],content:t[5]};return 7===t.length&&(i.sig=t[6]),8===t.length&&(i.id=t[7]),i}(i))}rawEvent(){return{created_at:this.created_at,content:this.content,tags:this.tags,kind:this.kind,pubkey:this.pubkey,id:this.id,sig:this.sig}}set author(e){this.pubkey=e.pubkey,this._author=void 0}get author(){if(this._author)return this._author;if(!this.ndk)throw Error("No NDK instance found");let e=this.ndk.getUser({pubkey:this.pubkey});return this._author=e,e}tag(t,i,s,r){let n=[];if(void 0!==t.fetchProfile){let e=[r??="p",t.pubkey];i&&e.push("",i),n.push(e)}else if(t instanceof e)for(let e of(s??=t?.pubkey===this.pubkey,n=t.referenceTags(i,s,r),t.getMatchingTags("p")))e[1]!==this.pubkey&&(this.tags.find(t=>"p"===t[0]&&t[1]===e[1])||this.tags.push(["p",e[1]]));else if(Array.isArray(t))n=[t];else throw Error("Invalid argument",t);this.tags=function(e,t){let i=new Map,s=e=>e.join(","),r=(e,t)=>e.every((e,i)=>e===t[i]);return e.concat(t).forEach(e=>{for(let[t,s]of i)if(r(s,e)||r(e,s)){e.length>=s.length&&i.set(t,e);return}i.set(s(e),e)}),Array.from(i.values())}(this.tags,n)}async toNostrEvent(e){if(!e&&""===this.pubkey){let e=await this.ndk?.signer?.user();this.pubkey=e?.pubkey||""}this.created_at||(this.created_at=Math.floor(Date.now()/1e3));let{content:t,tags:i}=await this.generateTags();this.content=t||"",this.tags=i;try{this.id=this.getEventHash()}catch(e){}return this.rawEvent()}serialize=J.bind(this);getEventHash=es.bind(this);validate=ee.bind(this);verifySignature=ei.bind(this);isReplaceable=F.bind(this);isEphemeral=$.bind(this);isParamReplaceable=O.bind(this);encode=H.bind(this);encrypt=V.bind(this);decrypt=G.bind(this);getMatchingTags(e,t){return this.tags.filter(t=>t[0]===e).filter(e=>!t||e[3]===t)}tagValue(e){let t=this.getMatchingTags(e);if(0!==t.length)return t[0][1]}get alt(){return this.tagValue("alt")}set alt(e){this.removeTag("alt"),e&&this.tags.push(["alt",e])}get dTag(){return this.tagValue("d")}set dTag(e){this.removeTag("d"),e&&this.tags.push(["d",e])}removeTag(e){this.tags=this.tags.filter(t=>t[0]!==e)}async sign(e){e?this.author=await e.user():(this.ndk?.assertSigner(),e=this.ndk.signer);let t=await this.toNostrEvent();return console.log("signing",t),this.sig=await e.sign(t),this.sig}async publish(e,t){if(this.sig||await this.sign(),!this.ndk)throw Error("NDKEvent must be associated with an NDK instance to publish");e||(e=this.ndk.devWriteRelaySet||function(e,t){let i=new Set;return e.pool?.permanentAndConnectedRelays().forEach(e=>i.add(e)),new I(i,e)}(this.ndk,0)),this.ndk.debug(`publish to ${e.size} relays`,this.rawEvent()),5===this.kind&&this.ndk.cacheAdapter?.deleteEvent&&this.ndk.cacheAdapter.deleteEvent(this);let i=await e.publish(this,t);return this.onRelays=Array.from(i),i}async generateTags(){let e=[],t=await z(this.content,this.tags),i=t.content;if(e=t.tags,this.kind&&this.isParamReplaceable()&&!this.getMatchingTags("d")[0]){let t=this.tagValue("title"),i=[...Array(t?6:16)].map(()=>Math.random().toString(36)[2]).join("");t&&t.length>0&&(i=t.replace(/[^a-z0-9]+/gi,"-").replace(/^-|-$/g,"")+"-"+i),e.push(["d",i])}if((this.ndk?.clientName||this.ndk?.clientNip89)&&!this.tagValue("client")){let t=["client",this.ndk.clientName??""];this.ndk.clientNip89&&t.push(this.ndk.clientNip89),e.push(t)}return{content:i||"",tags:e}}muted(){let e=this.ndk?.mutedIds.get(this.pubkey);if(e&&"p"===e)return"author";let t=this.tagReference(),i=this.ndk?.mutedIds.get(t[1]);return i&&i===t[0]?"event":null}replaceableDTag(){if(this.kind&&this.kind>=3e4&&this.kind<=4e4){let e=this.getMatchingTags("d")[0];return e?e[1]:""}throw Error("Event is not a parameterized replaceable event")}deduplicationKey(){return 0===this.kind||3===this.kind||this.kind&&this.kind>=1e4&&this.kind<2e4?`${this.kind}:${this.pubkey}`:this.tagId()}tagId(){return this.isParamReplaceable()?this.tagAddress():this.id}tagAddress(){if(!this.isParamReplaceable())throw Error("This must only be called on replaceable events");let e=this.replaceableDTag();return`${this.kind}:${this.pubkey}:${e}`}tagType(){return this.isParamReplaceable()?"a":"e"}tagReference(e){let t;return t=this.isParamReplaceable()?["a",this.tagAddress()]:["e",this.tagId()],this.relay?t.push(this.relay.url):t.push(""),e&&t.push(e),t}referenceTags(e,t,i){let s=[];return s=this.isParamReplaceable()?[[i??"a",this.tagAddress()],[i??"e",this.id]]:[[i??"e",this.id]],this.relay?.url?s=s.map(e=>(e.push(this.relay?.url),e)):e&&(s=s.map(e=>(e.push(""),e))),e&&s.forEach(t=>t.push(e)),t||s.push(...this.author.referenceTags()),s}filter(){return this.isParamReplaceable()?{"#a":[this.tagId()]}:{"#e":[this.tagId()]}}async zap(e,t,i,s,r){if(!this.ndk)throw Error("No NDK instance found");r||this.ndk.assertSigner();let n=new ea({ndk:this.ndk,zappedEvent:this,zappedUser:s}),a=Array.from(this.ndk.pool.relays.keys());return await n.createZapRequest(e,t,i,a,r)}async delete(t,i=!0){if(!this.ndk)throw Error("No NDK instance found");this.ndk.assertSigner();let s=new e(this.ndk,{kind:5,content:t||""});return s.tag(this),i&&await s.publish(),s}fetchTaggedEvent=j.bind(this);fetchRootEvent=B.bind(this);fetchReplyEvent=Z.bind(this);repost=K.bind(this);async react(t,i=!0){if(!this.ndk)throw Error("No NDK instance found");this.ndk.assertSigner();let s=new e(this.ndk,{kind:7,content:t});return s.tag(this),i?await s.publish():await s.sign(),s}get isValid(){return this.validate()}},eh=((n=eh||{}).ONLY_CACHE="ONLY_CACHE",n.CACHE_FIRST="CACHE_FIRST",n.PARALLEL="PARALLEL",n.ONLY_RELAY="ONLY_RELAY",n),el={closeOnEose:!1,cacheUsage:"CACHE_FIRST",groupable:!0,groupableDelay:100,groupableDelayType:"at-most"},ec=class extends l.EventEmitter{subId;filters;opts;pool;skipVerification=!1;skipValidation=!1;relayFilters;relaySet;ndk;debug;eoseDebug;eventFirstSeen=new Map;eosesSeen=new Set;eventsPerRelay=new Map;lastEventReceivedAt;internalId;closeOnEose;constructor(e,t,i,s,r){if(super(),this.ndk=e,this.pool=i?.pool||e.pool,this.opts={...el,...i||{}},this.filters=t instanceof Array?t:[t],this.subId=r||i?.subId,this.internalId=Math.random().toString(36).substring(7),this.relaySet=s,this.debug=e.debug.extend(`subscription[${i?.subId??this.internalId}]`),this.eoseDebug=this.debug.extend("eose"),this.skipVerification=i?.skipVerification||!1,this.skipValidation=i?.skipValidation||!1,this.closeOnEose=i?.closeOnEose||!1,"ONLY_CACHE"===this.opts.cacheUsage&&!this.opts.closeOnEose)throw Error("Cannot use cache-only options with a persistent subscription")}get filter(){return this.filters[0]}isGroupable(){return this.opts?.groupable||!1}shouldQueryCache(){return this.opts?.cacheUsage!=="ONLY_RELAY"}shouldQueryRelays(){return this.opts?.cacheUsage!=="ONLY_CACHE"}shouldWaitForCache(){return this.opts.closeOnEose&&!!this.ndk.cacheAdapter?.locking&&"PARALLEL"!==this.opts.cacheUsage}async start(){let e;if(this.shouldQueryCache()&&(e=this.startWithCache(),this.shouldWaitForCache()&&(await e,w(this)))){this.emit("eose",this);return}this.shouldQueryRelays()?this.startWithRelays():this.emit("eose",this)}stop(){this.emit("close",this),this.removeAllListeners()}hasAuthorsFilter(){return this.filters.some(e=>e.authors?.length)}async startWithCache(){if(this.ndk.cacheAdapter?.query){let e=this.ndk.cacheAdapter.query(this);this.ndk.cacheAdapter.locking&&await e}}startWithRelays(){if(this.relaySet)for(let e of(this.relayFilters=new Map,this.relaySet.relays))this.relayFilters.set(e.url,this.filters);else this.relayFilters=function(e,t,i){let s=new Map,r=new Set;if(t.forEach(e=>{e.authors&&e.authors.forEach(e=>r.add(e))}),r.size>0){let n=function(e,t,i,s=2){let r=new Map,{pubkeysToRelays:n,authorsMissingRelays:a}=function(e,t){let i=new Map,s=new Set;return t.forEach(t=>{let r=g(e,t);r&&r.size>0?(r.forEach(e=>{let s=i.get(e)||new Set;s.add(t),i.set(e,s)}),i.set(t,r)):s.add(t)}),{pubkeysToRelays:i,authorsMissingRelays:s}}(e,t),o=function(e,t){let i=new Map;return t.forEach(t=>{let s=g(e,t);s&&s.forEach(e=>{let t=i.get(e)||0;i.set(e,t+1)})}),Array.from(i.entries()).sort((e,t)=>t[1]-e[1]).map(e=>e[0])}(e,t),h=(e,t)=>{let i=r.get(t)||[];i.push(e),r.set(t,i)};for(let[e,t]of n.entries()){let n=s;for(let s of i.connectedRelays())t.has(s.url)&&(h(e,s.url),n--);for(let i of t)r.has(i)&&(h(e,i),n--);if(!(n<=0))for(let i of o){if(n<=0)break;t.has(i)&&(h(e,i),n--)}}for(let e of a)i.permanentAndConnectedRelays().forEach(t=>{let i=r.get(t.url)||[];i.push(e),r.set(t.url,i)});return r}(e,Array.from(r),i);for(let e of n.keys())s.set(e,[]);for(let e of t)if(e.authors)for(let[t,i]of n.entries()){let r=e.authors.filter(e=>i.includes(e));s.set(t,[...s.get(t),{...e,authors:r}])}else for(let t of n.keys())s.set(t,[...s.get(t),e])}else i.permanentAndConnectedRelays().forEach(e=>{s.set(e.url,t)});return s}(this.ndk,this.filters,this.pool);if(!this.relayFilters||0===this.relayFilters.size){this.debug("No relays to subscribe to",this.pool.relays.size);return}for(let[e,t]of this.relayFilters)this.pool.getRelay(e,!0,!0,t).subscribe(this,t)}eventReceived(e,t,i=!1){if(t&&(e.relay??=t,e.onRelays.push(t)),t||(t=e.relay),e.ndk??=this.ndk,!i&&t&&this.ndk.emit("event",e,t),this.eventFirstSeen.has(e.id)){let i=Date.now()-(this.eventFirstSeen.get(e.id)||0);t&&(t.scoreSlowerEvent(i),this.trackPerRelay(e,t)),this.emit("event:dup",e,t,i,this);return}if(!i){if(!this.skipValidation&&!e.isValid){this.debug("Event failed validation",e.rawEvent());return}if(e.relay?.shouldValidateEvent()!==!1&&!this.skipVerification&&!e.verifySignature(!0)&&!this.ndk.asyncSigVerification){this.debug("Event failed signature validation",e);return}}!i&&t?(this.trackPerRelay(e,t),this.ndk.cacheAdapter&&this.ndk.cacheAdapter.setEvent(e,this.filters,t),this.eventFirstSeen.set(e.id,Date.now())):this.eventFirstSeen.set(e.id,0),this.emit("event",e,t,this),this.lastEventReceivedAt=Date.now()}trackPerRelay(e,t){let i=this.eventsPerRelay.get(t);i||(i=new Set,this.eventsPerRelay.set(t,i)),i.add(e.id)}eoseTimeout;eoseReceived(e){this.eosesSeen.add(e);let t=this.lastEventReceivedAt?Date.now()-this.lastEventReceivedAt:void 0,i=this.eosesSeen.size===this.relayFilters?.size;if(w(this))this.emit("eose"),this.opts?.closeOnEose&&this.stop();else if(i)this.emit("eose"),this.eoseDebug("All EOSEs seen"),this.opts?.closeOnEose&&this.stop();else{let e=1e3,i=this.eosesSeen.size/this.relayFilters.size;if(this.eosesSeen.size>=2&&i>=.5){e*=1-i,this.eoseTimeout&&clearTimeout(this.eoseTimeout);let s=()=>{void 0!==(t=this.lastEventReceivedAt?Date.now()-this.lastEventReceivedAt:void 0)&&t<20?this.eoseTimeout=setTimeout(s,e):(this.emit("eose"),this.opts?.closeOnEose&&this.stop())};this.eoseTimeout=setTimeout(s,e)}}}};async function eu(e,t,i=3){if(!this.ndk)throw Error("NDK not set");let s=await this.ndk.fetchEvent({kinds:[i],authors:[this.pubkey]},e||{groupable:!1});if(s){let e=new Set;return s.tags.forEach(t=>{"p"===t[0]&&e.add(t[1])}),t&&this.ndk?.outboxTracker?.trackUsers(Array.from(e)),[...e].reduce((e,t)=>{let i=new ey({pubkey:t});return i.ndk=this.ndk,e.add(i),e},new Set)}return new Set}var ed=/^(?:([\w.+-]+)@)?([\w.-]+)$/;async function ep(e,t,i=fetch,s={}){return await e.queuesNip05.add({id:t,func:async()=>{if(e.cacheAdapter&&e.cacheAdapter.loadNip05){let i=await e.cacheAdapter.loadNip05(t);if("missing"!==i){if(i){let t=new ey({pubkey:i.pubkey,relayUrls:i.relays,nip46Urls:i.nip46});return t.ndk=e,t}if("no-cache"!==s.cache)return null}}let r=t.match(ed);if(!r)return null;let[n,a="_",o]=r;try{let r=await i(`https://${o}/.well-known/nostr.json?name=${a}`,s),{names:n,relays:h,nip46:l}=function(e){let t={names:{}};for(let[i,s]of Object.entries(e.names))"string"==typeof i&&"string"==typeof s&&(t.names[i.toLowerCase()]=s);if(e.relays)for(let[i,s]of(t.relays={},Object.entries(e.relays)))"string"==typeof i&&Array.isArray(s)&&(t.relays[i]=s.filter(e=>"string"==typeof e));if(e.nip46)for(let[i,s]of(t.nip46={},Object.entries(e.nip46)))"string"==typeof i&&Array.isArray(s)&&(t.nip46[i]=s.filter(e=>"string"==typeof e));return t}(await r.json()),c=n[a.toLowerCase()],u=null;return c&&(u={pubkey:c,relays:h?.[c],nip46:l?.[c]}),e?.cacheAdapter&&e.cacheAdapter.saveNip05&&e.cacheAdapter.saveNip05(t,u),u}catch(i){return e?.cacheAdapter&&e.cacheAdapter.saveNip05&&e?.cacheAdapter.saveNip05(t,null),console.error("Failed to fetch NIP05 for",t,i),null}}})}var ey=class e{ndk;profile;_npub;_pubkey;relayUrls=[];nip46Urls=[];constructor(e){e.npub&&(this._npub=e.npub),e.hexpubkey&&(this._pubkey=e.hexpubkey),e.pubkey&&(this._pubkey=e.pubkey),e.relayUrls&&(this.relayUrls=e.relayUrls),e.nip46Urls&&(this.nip46Urls=e.nip46Urls)}get npub(){if(!this._npub){if(!this._pubkey)throw Error("pubkey not set");this._npub=h.uD.npubEncode(this.pubkey)}return this._npub}set npub(e){this._npub=e}get hexpubkey(){return this.pubkey}set hexpubkey(e){this._pubkey=e}get pubkey(){if(!this._pubkey){if(!this._npub)throw Error("npub not set");this._pubkey=h.uD.decode(this.npub).data}return this._pubkey}set pubkey(e){this._pubkey=e}async getZapConfiguration(e){if(!(e??=this.ndk))throw Error("No NDK instance found");let t=async()=>{let t;if(this.ndk?.cacheAdapter?.loadUsersLNURLDoc){let e=await this.ndk.cacheAdapter.loadUsersLNURLDoc(this.pubkey);if("missing"!==e){if(null===e)return;if(e)return e}}let i=new ea({ndk:e,zappedUser:this});try{t=await i.getZapSpecWithoutCache()}catch{}if(this.ndk?.cacheAdapter?.saveUsersLNURLDoc&&this.ndk.cacheAdapter.saveUsersLNURLDoc(this.pubkey,t||null),t)return t};return await e.queuesZapConfig.add({id:this.pubkey,func:t})}async getZapperPubkey(){let e=await this.getZapConfiguration();return e?.nostrPubkey}static async fromNip05(t,i,s=!1){if(!i)throw Error("No NDK instance found");let r={};s&&(r.cache="no-cache");let n=await ep(i,t,i?.httpFetch,r);if(n){let t=new e({pubkey:n.pubkey,relayUrls:n.relays,nip46Urls:n.nip46});return t.ndk=i,t}}async fetchProfile(e){if(!this.ndk)throw Error("NDK not set");this.profile||(this.profile={});let t=null;if(this.ndk.cacheAdapter&&this.ndk.cacheAdapter.fetchProfile&&e?.cacheUsage!=="ONLY_RELAY"){let e=await this.ndk.cacheAdapter.fetchProfile(this.pubkey);if(e)return this.profile=e,e}!e&&this.ndk.cacheAdapter&&this.ndk.cacheAdapter.locking&&(t=await this.ndk.fetchEvents({kinds:[0],authors:[this.pubkey]},{cacheUsage:"ONLY_CACHE",closeOnEose:!0,groupable:!1}),e={cacheUsage:"ONLY_RELAY",closeOnEose:!0,groupable:!0,groupableDelay:250}),t&&0!==t.size||(t=await this.ndk.fetchEvents({kinds:[0],authors:[this.pubkey]},e));let i=Array.from(t).sort((e,t)=>e.created_at-t.created_at);return 0===i.length?null:(this.profile=function(e){let t;let i={};try{t=JSON.parse(e.content)}catch(e){throw Error(`Failed to parse profile event: ${e}`)}return Object.keys(t).forEach(e=>{switch(e){case"name":i.name=t.name;break;case"display_name":i.displayName=t.display_name;break;case"image":case"picture":i.image=t.picture||t.image;break;case"banner":i.banner=t.banner;break;case"bio":i.bio=t.bio;break;case"nip05":i.nip05=t.nip05;break;case"lud06":i.lud06=t.lud06;break;case"lud16":i.lud16=t.lud16;break;case"about":i.about=t.about;break;case"zapService":i.zapService=t.zapService;break;case"website":i.website=t.website;break;default:i[e]=t[e]}}),i}(i[0]),this.profile&&this.ndk.cacheAdapter&&this.ndk.cacheAdapter.saveProfile&&this.ndk.cacheAdapter.saveProfile(this.pubkey,this.profile),this.profile)}follows=eu.bind(this);tagReference(){return["p",this.pubkey]}referenceTags(e){let t=[["p",this.pubkey]];return e&&t[0].push("",e),t}async publish(){if(!this.ndk)throw Error("No NDK instance found");if(!this.profile)throw Error("No profile available");this.ndk.assertSigner();let e=new eo(this.ndk,{kind:0,content:function(e){let t={};for(let[i,s]of Object.entries(e))switch(i){case"username":case"name":t.name=s;break;case"displayName":t.display_name=s;break;case"image":case"picture":t.picture=s;break;case"bio":case"about":t.about=s;break;default:t[i]=s}return JSON.stringify(t)}(this.profile)});await e.publish()}async follow(e,t,i=3){if(!this.ndk)throw Error("No NDK instance found");if(this.ndk.assertSigner(),t||(t=await this.follows(void 0,void 0,i)),t.has(e))return!1;t.add(e);let s=new eo(this.ndk,{kind:i});for(let e of t)s.tag(e);return await s.publish(),!0}async unfollow(e,t,i=3){if(!this.ndk)throw Error("No NDK instance found");this.ndk.assertSigner(),t||(t=await this.follows(void 0,void 0,i));let s=new Set,r=!1;for(let i of t)i.pubkey!==e.pubkey&&(s.add(i),r=!0);if(!r)return!1;let n=new eo(this.ndk,{kind:i});for(let e of t)n.tag(e);return await n.publish()}async validateNip05(e){if(!this.ndk)throw Error("No NDK instance found");let t=await ep(this.ndk,e);return null===t?null:t.pubkey===this.pubkey}async zap(e,t,i,s){if(!this.ndk)throw Error("No NDK instance found");s||this.ndk.assertSigner();let r=new ea({ndk:this.ndk,zappedUser:this}),n=Array.from(this.ndk.pool.relays.keys());return await r.createZapRequest(e,t,i,n,s)}},ef=class e extends eo{_encryptedTags;encryptedTagsLength;constructor(e,t){super(e,t),this.kind??=30001}static from(t){return new e(t.ndk,t.rawEvent())}get title(){let e=this.tagValue("title")||this.tagValue("name");if(3===this.kind&&!e)return"Contacts";if(1e4===this.kind&&!e)return"Mute";if(10001===this.kind&&!e)return"Pinned Notes";if(10002===this.kind&&!e)return"Relay Metadata";if(10003===this.kind&&!e)return"Bookmarks";if(10004===this.kind&&!e)return"Communities";if(10005===this.kind&&!e)return"Public Chats";else if(10006===this.kind&&!e)return"Blocked Relays";else if(10007===this.kind&&!e)return"Search Relays";else if(10015===this.kind&&!e)return"Interests";else if(10030===this.kind&&!e)return"Emojis";else return e??this.tagValue("d")}set title(e){if(this.removeTag("title"),this.removeTag("name"),e)this.tags.push(["title",e]);else throw Error("Title cannot be empty")}get name(){let e=this.tagValue("name");if(3===this.kind&&!e)return"Contacts";if(1e4===this.kind&&!e)return"Mute";if(10001===this.kind&&!e)return"Pinned Notes";if(10002===this.kind&&!e)return"Relay Metadata";if(10003===this.kind&&!e)return"Bookmarks";if(10004===this.kind&&!e)return"Communities";if(10005===this.kind&&!e)return"Public Chats";else if(10006===this.kind&&!e)return"Blocked Relays";else if(10007===this.kind&&!e)return"Search Relays";else if(10015===this.kind&&!e)return"Interests";else if(10030===this.kind&&!e)return"Emojis";else return e??this.tagValue("d")}set name(e){if(this.removeTag("name"),e)this.tags.push(["title",e]);else throw Error("Name cannot be empty")}get description(){return this.tagValue("description")}set description(e){e?this.tags.push(["description",e]):this.removeTag("description")}isEncryptedTagsCacheValid(){return!!(this._encryptedTags&&this.encryptedTagsLength===this.content.length)}async encryptedTags(e=!0){if(e&&this.isEncryptedTagsCacheValid())return this._encryptedTags;if(!this.ndk)throw Error("NDK instance not set");if(!this.ndk.signer)throw Error("NDK signer not set");let t=await this.ndk.signer.user();try{if(this.content.length>0)try{let e=await this.ndk.signer.decrypt(t,this.content),i=JSON.parse(e);if(i&&i[0])return this.encryptedTagsLength=this.content.length,this._encryptedTags=i;return this.encryptedTagsLength=this.content.length,this._encryptedTags=[]}catch(e){console.log(`error decrypting ${this.content}`)}}catch(e){}return[]}validateTag(e){return!0}getItems(e){return this.tags.filter(t=>t[0]===e)}get items(){return this.tags.filter(e=>!["d","L","l","title","name","description","summary","image","thumb","alt","expiration","subject","client"].includes(e[0]))}async addItem(e,t,i=!1,s="bottom"){let r;if(!this.ndk)throw Error("NDK instance not set");if(!this.ndk.signer)throw Error("NDK signer not set");if(e instanceof eo)r=[e.tagReference(t)];else if(e instanceof ey)r=e.referenceTags();else if(e instanceof D)r=e.referenceTags();else if(Array.isArray(e))r=[e];else throw Error("Invalid object type");if(t&&r[0].push(t),i){let e=await this.ndk.signer.user(),t=await this.encryptedTags();"top"===s?t.unshift(...r):t.push(...r),this._encryptedTags=t,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(t),await this.encrypt(e)}else"top"===s?this.tags.unshift(...r):this.tags.push(...r);this.created_at=Math.floor(Date.now()/1e3),this.emit("change")}async removeItem(e,t){if(!this.ndk)throw Error("NDK instance not set");if(!this.ndk.signer)throw Error("NDK signer not set");if(t){let t=await this.ndk.signer.user(),i=await this.encryptedTags();i.splice(e,1),this._encryptedTags=i,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(i),await this.encrypt(t)}else this.tags.splice(e,1);return this.created_at=Math.floor(Date.now()/1e3),this.emit("change"),this}filterForItems(){let e=new Set,t=new Map,i=[];for(let i of this.items)if("e"===i[0]&&i[1])e.add(i[1]);else if("a"===i[0]&&i[1]){let[e,s,r]=i[1].split(":");if(!e||!s)continue;let n=`${e}:${s}`,a=t.get(n)||[];a.push(r||""),t.set(n,a)}if(e.size>0&&i.push({ids:Array.from(e)}),t.size>0)for(let[e,s]of t.entries()){let[t,r]=e.split(":");i.push({kinds:[parseInt(t)],authors:[r],"#d":s})}return i}},eg="read",em="write",eb=class e extends eo{constructor(e,t){super(e,t),this.kind??=10002}static from(t){return new e(t.ndk,t.rawEvent())}static async forUser(e,t){return(await this.forUsers([e],t)).get(e)}static async forUsers(t,i){let s=i.outboxPool||i.pool,r=new Set;for(let e of s.relays.values())r.add(e);let n=new Map,a=new Map,o=new I(r,i);if(i.cacheAdapter?.locking){let s=await i.fetchEvents({kinds:[3,10002],authors:t},{cacheUsage:"ONLY_CACHE"});for(let t of s)10002===t.kind&&n.set(t.pubkey,e.from(t));for(let e of s)if(3===e.kind){let t=ek(i,e);t&&a.set(e.pubkey,t)}t=t.filter(e=>!n.has(e)&&!a.has(e))}if(0===t.length)return n;await Promise.all([new Promise(async r=>{for(let r of(await i.fetchEvents({kinds:[10002],authors:t},{closeOnEose:!0,pool:s,groupable:!1},o)))n.set(r.pubkey,e.from(r));r()}),new Promise(async e=>{for(let e of(await i.fetchEvents({kinds:[3],authors:t},{closeOnEose:!0,pool:s,groupable:!1},o))){let t=ek(i,e);t&&a.set(e.pubkey,t)}e()})]);let h=new Map;for(let e of t){let t=n.get(e)??a.get(e);t&&h.set(e,t)}return h}get readRelayUrls(){return this.tags.filter(e=>"r"===e[0]||"relay"===e[0]).filter(e=>!e[2]||e[2]&&e[2]===eg).map(e=>e[1])}set readRelayUrls(e){for(let t of e)this.tags.push(["r",t,eg])}get writeRelayUrls(){return this.tags.filter(e=>"r"===e[0]||"relay"===e[0]).filter(e=>!e[2]||e[2]&&e[2]===em).map(e=>e[1])}set writeRelayUrls(e){for(let t of e)this.tags.push(["r",t,em])}get bothRelayUrls(){return this.tags.filter(e=>"r"===e[0]||"relay"===e[0]).filter(e=>!e[2]).map(e=>e[1])}set bothRelayUrls(e){for(let t of e)this.tags.push(["r",t])}get relays(){return this.tags.filter(e=>"r"===e[0]||"relay"===e[0]).map(e=>e[1])}};function ek(e,t){try{let i=JSON.parse(t.content),s=new eb(e),r=new Set,n=new Set;for(let[e,t]of Object.entries(i)){try{e=U(e)}catch{continue}t?(t.write&&n.add(e),t.read&&r.add(e)):(r.add(e),n.add(e))}return s.readRelayUrls=Array.from(r),s.writeRelayUrls=Array.from(n),s}catch{}}var ew=((a=ew||{}).Processing="processing",a.Success="success",a.Scheduled="scheduled",a.PayReq="payment_required",a);async function ev(e){return await this.sendReq("pay_invoice",{invoice:e})}var eR=class e{_user;privateKey;constructor(e){e&&(this.privateKey=e,this._user=new ey({pubkey:(0,h.$3)(this.privateKey)}))}static generate(){return new e((0,h.wQ)())}async blockUntilReady(){if(!this._user)throw Error("NDKUser not initialized");return this._user}async user(){return await this.blockUntilReady(),this._user}async sign(e){if(!this.privateKey)throw Error("Attempted to sign without a private key");return(0,h.o$)(e,this.privateKey)}async encrypt(e,t){if(!this.privateKey)throw Error("Attempted to encrypt without a private key");let i=e.pubkey;return await h._J.encrypt(this.privateKey,i,t)}async decrypt(e,t){if(!this.privateKey)throw Error("Attempted to decrypt without a private key");let i=e.pubkey;return await h._J.decrypt(this.privateKey,i,t)}};async function eE(e,t){let i=new eo(this.ndk,{kind:23194,tags:[["p",this.walletService.pubkey]],content:JSON.stringify({method:e,params:t})});return this.debug("Sending request",i.content),await i.encrypt(this.walletService,this.signer),await i.sign(this.signer),this.debug("Request encrypted and signed"),new Promise(async(t,s)=>{try{let r=i.tagId();if(!r)throw Error("Failed to get e-tag");let n=e=>{this.off(r,n),this.off("event",n),this.debug("Received response",e);try{let i=JSON.parse(e);i.error&&s(i),t(i)}catch(e){this.debug("Failed to parse response",e),s({result_type:"error",error:{code:"failed_to_parse_response",message:e.message}})}},a=this.ndk.subscribe({kinds:[23195],"#e":[r],limit:1},{groupable:!1,subId:`nwc-${e}`},this.relaySet);a.on("event",async e=>{await e.decrypt(e.author,this.signer),n(e.content),a.stop()}),this.once(r,n),this.once("event",n),this.debug("Sending request to relay",i.rawEvent()),await i.publish(this.relaySet)}catch(e){this.debug("Failed to send request",e,e.relayErrors),s({result_type:"error",error:{code:"failed_to_send_request",message:e.message}})}})}async function eS(){return await this.sendReq("get_balance",{})}async function eT(){return await this.sendReq("get_info",{})}var eA=class e extends l.EventEmitter{ndk;debug;walletService;relaySet;signer;active=!1;constructor({ndk:e,pubkey:t,relayUrls:i,secret:s}){super(),this.ndk=e,this.walletService=e.getUser({pubkey:t}),this.relaySet=new I(new Set(i.map(t=>e.pool.getRelay(t))),e),this.signer=new eR(s),this.debug=e.debug.extend("nwc"),this.debug(`Starting with wallet service ${this.walletService.npub}`)}static async fromURI(t,i){let s=new URL(i);if("nostr+walletconnect:"!==s.protocol)throw Error("Invalid protocol");return new e({ndk:t,pubkey:s.host??s.pathname,relayUrls:s.searchParams.getAll("relay")??[""],secret:s.searchParams.get("secret")??""})}async blockUntilReady(e){let t=await this.signer.user(),i=new Promise((t,i)=>{setTimeout(()=>{i(Error("Timeout"))},e)}),s=[new Promise(e=>{let i=this.ndk.subscribe({kinds:[23195],"#p":[t.pubkey],limit:1},{groupable:!1,subId:"nwc"},this.relaySet);i.on("event",async e=>{this.debug("received response",e.rawEvent());let t=e.tagValue("e");if(!t){this.debug("Received an event without an e-tag");return}this.debug("received an event",t);try{await e.decrypt(e.author,this.signer),this.emit(t,e.content)}catch(e){this.debug("Failed to decrypt event",e);return}}),i.on("eose",()=>{this.debug("Subscription ready"),this.active=!0,e()}),i.on("close",()=>{this.debug("Subscription closed"),this.active=!1})})];return e&&s.push(i),await Promise.race(s)}async sendReq(e,t){return await eE.call(this,e,t)}async payInvoice(e){return await ev.call(this,e)}async getInfo(){return await eT.call(this)}getBalance=eS.bind(this)},eN=class{_userPromise;nip04Queue=[];nip04Processing=!1;debug;waitTimeout;constructor(e=1e3){this.debug=c("ndk:nip07"),this.waitTimeout=e}async blockUntilReady(){await this.waitForExtension();let e=await window.nostr.getPublicKey();if(!e)throw Error("User rejected access");return new ey({pubkey:e})}async user(){return this._userPromise||(this._userPromise=this.blockUntilReady()),this._userPromise}async sign(e){return await this.waitForExtension(),(await window.nostr.signEvent(e)).sig}async relays(){await this.waitForExtension();let e=await window.nostr.getRelays?.()||{},t=[];for(let i of Object.keys(e))e[i].read&&e[i].write&&t.push(i);return t.map(e=>new D(e))}async encrypt(e,t){await this.waitForExtension();let i=e.pubkey;return this.queueNip04("encrypt",i,t)}async decrypt(e,t){await this.waitForExtension();let i=e.pubkey;return this.queueNip04("decrypt",i,t)}async queueNip04(e,t,i){return new Promise((s,r)=>{this.nip04Queue.push({type:e,counterpartyHexpubkey:t,value:i,resolve:s,reject:r}),this.nip04Processing||this.processNip04Queue()})}async processNip04Queue(e,t=0){if(!e&&0===this.nip04Queue.length){this.nip04Processing=!1;return}this.nip04Processing=!0;let{type:i,counterpartyHexpubkey:s,value:r,resolve:n,reject:a}=e||this.nip04Queue.shift();this.debug("Processing encryption queue item",{type:i,counterpartyHexpubkey:s,value:r});try{let e;e="encrypt"===i?await window.nostr.nip04.encrypt(s,r):await window.nostr.nip04.decrypt(s,r),n(e)}catch(n){if(n.message&&n.message.includes("call already executing")&&t<5){this.debug("Retrying encryption queue item",{type:i,counterpartyHexpubkey:s,value:r,retries:t}),setTimeout(()=>{this.processNip04Queue(e,t+1)},50*t);return}a(n)}this.processNip04Queue()}waitForExtension(){return new Promise((e,t)=>{let i;if(window.nostr){e();return}let s=setInterval(()=>{window.nostr&&(clearTimeout(i),clearInterval(s),e())},100);i=setTimeout(()=>{clearInterval(s),t(Error("NIP-07 extension not available"))},this.waitTimeout)})}};l.EventEmitter;l.EventEmitter;var eP=class{type;relayUrlScores;readRelays;writeRelays;constructor(e){this.type=e,this.relayUrlScores=new Map,this.readRelays=new Set,this.writeRelays=new Set}},eC=class extends l.EventEmitter{data;ndk;debug;constructor(e){super(),this.ndk=e,this.debug=e.debug.extend("outbox-tracker"),this.data=new y.LRUCache({maxSize:1e5,entryExpirationTimeInMS:12e4})}trackUsers(e){for(let t=0;t<e.length;t+=400){let i=e.slice(t,t+400).map(e=>eU(e)).filter(e=>!this.data.has(e));if(0!==i.length){for(let e of i)this.data.set(e,new eP("user"));eb.forUsers(i,this.ndk).then(e=>{for(let[t,i]of e){let e=this.data.get(t);if(i){for(let t of(e.readRelays=new Set(_(i.readRelayUrls)),e.writeRelays=new Set(_(i.writeRelayUrls)),e.readRelays))this.ndk.pool.blacklistRelayUrls.has(t)&&e.readRelays.delete(t);for(let t of e.writeRelays)this.ndk.pool.blacklistRelayUrls.has(t)&&e.writeRelays.delete(t);this.data.set(t,e)}}})}}}track(e,t){let i=eU(e);t??=e instanceof ey?"user":"kind";let s=this.data.get(i);return!s&&(s=new eP(t),e instanceof ey&&this.trackUsers([e])),s}};function eU(e){return e instanceof ey?e.pubkey:e}var e_=class extends l.EventEmitter{relays=new Map;blacklistRelayUrls;debug;temporaryRelayTimers=new Map;flappingRelays=new Set;backoffTimes=new Map;ndk;constructor(e=[],t=[],i,s){for(let t of(super(),this.debug=s??i.debug.extend("pool"),this.ndk=i,e)){let e=new D(t);this.addRelay(e,!1)}this.blacklistRelayUrls=new Set(t)}set name(e){this.debug=this.debug.extend(e)}useTemporaryRelay(e,t=3e4){let i=this.relays.has(e.url);i||this.addRelay(e);let s=this.temporaryRelayTimers.get(e.url);if(s&&clearTimeout(s),!i||s){let i=setTimeout(()=>{this.removeRelay(e.url)},t);this.temporaryRelayTimers.set(e.url,i)}}addRelay(e,t=!0){let i=this.relays.has(e.url),s=this.blacklistRelayUrls?.has(e.url),r=e.url.includes("/npub1"),n=!0,a=e.url;if(i){this.debug(`Refusing to add relay ${a}: already in the pool`);return}if(s){this.debug(`Refusing to add relay ${a}: blacklisted`);return}if(r){this.debug(`Refusing to add relay ${a}: is a filter relay`);return}if(this.ndk.cacheAdapter?.getRelayStatus){let i=this.ndk.cacheAdapter.getRelayStatus(a);if(i&&i.dontConnectBefore){if(i.dontConnectBefore>Date.now()){let s=i.dontConnectBefore-Date.now();this.debug(`Refusing to add relay ${a}: delayed connect for ${s}ms`),setTimeout(()=>{this.addRelay(e,t)},s);return}n=!1}}this.debug(`Adding relay ${a} to the pool`);let o=t=>this.emit("notice",e,t),h=()=>this.handleRelayConnect(a),l=()=>this.handleRelayReady(e),c=()=>this.emit("relay:disconnect",e),u=()=>this.handleFlapping(e),d=t=>this.emit("relay:auth",e,t),p=()=>this.emit("relay:authed",e);e.off("notice",o),e.off("connect",h),e.off("ready",l),e.off("disconnect",c),e.off("flapping",u),e.off("auth",d),e.off("authed",p),e.on("notice",o),e.on("connect",h),e.on("ready",l),e.on("disconnect",c),e.on("flapping",u),e.on("auth",d),e.on("authed",p),e.on("delayed-connect",t=>{this.ndk.cacheAdapter?.updateRelayStatus&&this.ndk.cacheAdapter.updateRelayStatus(e.url,{dontConnectBefore:Date.now()+t})}),this.relays.set(a,e),t&&(this.emit("relay:connecting",e),e.connect(void 0,n).catch(e=>{this.debug(`Failed to connect to relay ${a}`,e)}))}removeRelay(e){let t=this.relays.get(e);if(t)return t.disconnect(),this.relays.delete(e),this.emit("relay:disconnect",t),!0;let i=this.temporaryRelayTimers.get(e);return i&&(clearTimeout(i),this.temporaryRelayTimers.delete(e)),!1}getRelay(e,t=!0,i=!1,s){let r=this.relays.get(e);return r||(r=new D(e),i?this.useTemporaryRelay(r):this.addRelay(r,t)),r}handleRelayConnect(e){this.emit("relay:connect",this.relays.get(e)),this.stats().connected===this.relays.size&&this.emit("connect")}handleRelayReady(e){this.debug(`Relay ${e.url} ready`),this.emit("relay:ready",e)}async connect(e){let t=[];for(let i of(this.debug(`Connecting to ${this.relays.size} relays${e?`, timeout ${e}...`:""}`),this.relays.values())){let s=new Promise((t,s)=>(this.emit("relay:connecting",i),i.connect(e).then(t).catch(s)));if(e){let r=new Promise((t,i)=>{setTimeout(()=>i(`Timed out after ${e}ms`),e)});t.push(Promise.race([s,r]).catch(e=>{this.debug(`Failed to connect to relay ${i.url}: ${e??"No reason specified"}`)}))}else t.push(s)}e&&setTimeout(()=>{let e=this.stats().connected===this.relays.size,t=this.stats().connected>0;!e&&t&&this.emit("connect")},e),await Promise.all(t)}checkOnFlappingRelays(){if(this.flappingRelays.size/this.relays.size>=.8)for(let e of this.flappingRelays)this.backoffTimes.set(e,0)}handleFlapping(e){this.debug(`Relay ${e.url} is flapping`);let t=this.backoffTimes.get(e.url)||5e3;t*=2,this.backoffTimes.set(e.url,t),this.debug(`Backoff time for ${e.url} is ${t}ms`),setTimeout(()=>{this.debug(`Attempting to reconnect to ${e.url}`),this.emit("relay:connecting",e),e.connect(),this.checkOnFlappingRelays()},t),e.disconnect(),this.emit("flapping",e)}size(){return this.relays.size}stats(){let e={total:0,connected:0,disconnected:0,connecting:0};for(let t of this.relays.values())e.total++,1===t.status?e.connected++:3===t.status?e.disconnected++:0===t.status&&e.connecting++;return e}connectedRelays(){return Array.from(this.relays.values()).filter(e=>1===e.status)}permanentAndConnectedRelays(){return Array.from(this.relays.values()).filter(e=>1===e.status||!this.temporaryRelayTimers.has(e.url))}urls(){return Array.from(this.relays.keys())}};async function ex(e,t,i={type:"timeout"}){let s;let r=this.debug.extend("fetch-event-from-tag"),[n,a,o]=e,h=o&&""!==o?this.pool.getRelay(o,!0,!0,[{ids:[a]}]):void 0,l=new Promise(e=>{this.fetchEvent(a,t,h).then(e)});if(""===o||!o||"none"===i.type)return l;let c=new Promise(async e=>{let n=i.relaySet,o=i.timeout??1500,h=new Promise(e=>setTimeout(e,o));"timeout"===i.type&&await h,s?e(s):(r("fallback fetch triggered"),e(await this.fetchEvent(a,t,n)))});switch(i.type){case"timeout":return Promise.race([l,c]);case"eose":if(s=await l)return s;return c}}var eD=class{ndk;spec;url;nip98Required=!1;constructor(e,t){this.url=`https://${e}/.well-known/nostr/nip96.json`,this.ndk=t}async prepareUpload(e,t="POST"){if(this.validateHttpFetch(),this.spec||await this.fetchSpec(),!this.spec)throw Error("Failed to fetch NIP96 spec");let i={};return this.nip98Required&&(i={Authorization:await this.generateNip98Header(this.spec.api_url,t,e)}),{url:this.spec.api_url,headers:i}}async xhrUpload(e,t){let i="POST",{url:s,headers:r}=await this.prepareUpload(t,i);e.open(i,s,!0),r.Authorization&&e.setRequestHeader("Authorization",r.Authorization);let n=new FormData;return n.append("file",t),new Promise((t,i)=>{e.onload=function(){e.status>=200&&e.status<300?t(JSON.parse(e.responseText)):i(Error(e.statusText))},e.onerror=function(){i(Error("Network Error"))},e.send(n)})}async upload(e){let t="POST",{url:i,headers:s}=await this.prepareUpload(e,t),r=new FormData;r.append("file",e);let n=await this.ndk.httpFetch(this.spec.api_url,{method:t,headers:s,body:r});if(200!==n.status)throw Error(`Failed to upload file to ${i}`);let a=await n.json();if("success"!==a.status)throw Error(a.message);return a}validateHttpFetch(){if(!this.ndk)throw Error("NDK is required to fetch NIP96 spec");if(!this.ndk.httpFetch)throw Error("NDK must have an httpFetch method to fetch NIP96 spec")}async fetchSpec(){this.validateHttpFetch();let e=await this.ndk.httpFetch(this.url);if(200!==e.status)throw Error(`Failed to fetch NIP96 spec from ${this.url}`);let t=await e.json();if(!t)throw Error(`Failed to parse NIP96 spec from ${this.url}`);this.spec=t,this.nip98Required=this.spec.plans.free.is_nip98_required}async generateNip98Header(e,t,i){let s=new eo(this.ndk,{kind:27235,tags:[["u",e],["method",t]]});if(["POST","PUT","PATCH"].includes(t)){let e=await this.calculateSha256(i);s.tags.push(["payload",e])}await s.sign();let r=btoa(JSON.stringify(s.rawEvent()));return`Nostr ${r}`}async calculateSha256(e){let t=await e.arrayBuffer();return Array.from(new Uint8Array(await crypto.subtle.digest("SHA-256",t))).map(e=>e.toString(16).padStart(2,"0")).join("")}},eM=class{queue=[];maxConcurrency;processing=new Set;promises=new Map;constructor(e,t){this.maxConcurrency=t}add(e){if(this.promises.has(e.id))return this.promises.get(e.id);let t=new Promise((t,i)=>{this.queue.push({...e,func:()=>e.func().then(e=>(t(e),e),e=>{throw i(e),e})}),this.process()});return this.promises.set(e.id,t),t.finally(()=>{this.promises.delete(e.id),this.processing.delete(e.id)}),t}process(){if(this.processing.size>=this.maxConcurrency||0===this.queue.length)return;let e=this.queue.shift();!e||this.processing.has(e.id)||(this.processing.add(e.id),e.func())}clear(){this.queue=[]}clearProcessing(){this.processing.clear()}clearAll(){this.clear(),this.clearProcessing()}length(){return this.queue.length}},eI=["wss://purplepag.es/","wss://profiles.nos.social/"],ez=["wss://brb.io/","wss://nostr.mutinywallet.com/"],eL=class extends l.EventEmitter{explicitRelayUrls;pool;outboxPool;_signer;_activeUser;cacheAdapter;debug;devWriteRelaySet;outboxTracker;mutedIds;clientName;clientNip89;queuesZapConfig;queuesNip05;asyncSigVerification=!1;validationRatio=1;relayAuthDefaultPolicy;httpFetch;autoConnectUserRelays=!0;autoFetchUserMutelist=!0;constructor(e={}){super(),this.debug=e.debug||c("ndk"),this.explicitRelayUrls=e.explicitRelayUrls||[],this.pool=new e_(e.explicitRelayUrls||[],e.blacklistRelayUrls||ez,this),this.pool.name="main",this.debug(`Starting with explicit relays: ${JSON.stringify(this.explicitRelayUrls)}`),this.pool.on("relay:auth",async(e,t)=>{this.relayAuthDefaultPolicy&&await this.relayAuthDefaultPolicy(e,t)}),this.autoConnectUserRelays=e.autoConnectUserRelays??!0,this.autoFetchUserMutelist=e.autoFetchUserMutelist??!0,this.clientName=e.clientName,this.clientNip89=e.clientNip89,this.relayAuthDefaultPolicy=e.relayAuthDefaultPolicy,e.enableOutboxModel&&(this.outboxPool=new e_(e.outboxRelayUrls||eI,e.blacklistRelayUrls||ez,this,this.debug.extend("outbox-pool")),this.outboxPool.name="outbox",this.outboxTracker=new eC(this)),this.signer=e.signer,this.cacheAdapter=e.cacheAdapter,this.mutedIds=e.mutedIds||new Map,e.devWriteRelayUrls&&(this.devWriteRelaySet=I.fromRelayUrls(e.devWriteRelayUrls,this)),this.queuesZapConfig=new eM("zaps",3),this.queuesNip05=new eM("nip05",10),this.signatureVerificationWorker=e.signatureVerificationWorker,this.validationRatio=e.validationRatio||1;try{this.httpFetch=fetch}catch{}}set signatureVerificationWorker(e){this.asyncSigVerification=!!e,e&&((o=e).onmessage=e=>{let[t,i]=e.data,s=Q[t];if(!s){console.error("No record found for event",t);return}for(let e of(delete Q[t],s.resolves))e(i)})}addExplicitRelay(e,t,i=!0){let s;return s="string"==typeof e?new D(e,t):e,this.pool.addRelay(s,i),this.explicitRelayUrls.push(s.url),s}toJSON(){return({relayCount:this.pool.relays.size}).toString()}get activeUser(){return this._activeUser}set activeUser(e){let t=this._activeUser?.pubkey!==e?.pubkey;if(this._activeUser=e,e&&t){let t=async e=>{let t=await eb.forUser(e.pubkey,this);if(!t){this.debug("No relay list found for user",{npub:e.npub});return}for(let i of(this.debug("Connecting to user relays",{npub:e.npub,relays:t.relays}),t.relays)){let e=this.pool.relays.get(i);e||(e=new D(i),this.pool.addRelay(e))}},i=async e=>{let t=await this.fetchEvent({kinds:[1e4],authors:[e.pubkey]});if(t)for(let e of ef.from(t).items)this.mutedIds.set(e[1],e[0])},s=[async e=>{let t=await this.fetchEvent({kinds:[10006],authors:[e.pubkey]});if(t)for(let e of ef.from(t).items)this.pool.blacklistRelayUrls.add(e[0]);this.debug("Blocked relays",{blockedRelays:t})}];this.autoConnectUserRelays&&s.push(t),this.autoFetchUserMutelist&&s.push(i);let r=async e=>{for(let t of s)await t(e)},n=this.outboxPool||this.pool;n.connectedRelays.length>0?r(e):(this.debug("Waiting for connection to main relays"),n.once("connect",()=>{r(e)}))}else e||(this.mutedIds=new Map)}get signer(){return this._signer}set signer(e){this._signer=e,e&&this.emit("signer:ready",e),e?.user().then(e=>{e.ndk=this,this.activeUser=e})}async connect(e){this._signer&&this.autoConnectUserRelays&&(this.debug("Attempting to connect to user relays specified by signer"),this._signer.relays&&(await this._signer.relays()).forEach(e=>this.pool.addRelay(e)));let t=[this.pool.connect(e)];return this.outboxPool&&t.push(this.outboxPool.connect(e)),this.debug("Connecting to relays",{timeoutMs:e}),Promise.allSettled(t).then(()=>{})}getUser(e){let t=new ey(e);return t.ndk=this,t}async getUserFromNip05(e,t=!1){return ey.fromNip05(e,this,t)}subscribe(e,t,i,s=!0){let r=new ec(this,e,t,i);if(i)for(let e of i.relays)this.pool.useTemporaryRelay(e);if(this.outboxPool&&r.hasAuthorsFilter()){let e=r.filters.filter(e=>e.authors&&e.authors?.length>0).map(e=>e.authors).flat();this.outboxTracker?.trackUsers(e)}return s&&setTimeout(()=>r.start(),0),r}async publish(e,t,i){return this.debug("Deprecated: Use `event.publish()` instead"),e.publish(t,i)}fetchEventFromTag=ex.bind(this);async fetchEvent(e,t,i){let s,r;if(i instanceof D?r=new I(new Set([i]),this):i instanceof I&&(r=i),!i&&"string"==typeof e&&!(null!==e.match(v))){let t=function(e){try{let t=h.uD.decode(e);if(["naddr","nevent"].includes(t?.type)){let e=t.data;if(e?.relays)return e.relays.map(e=>new D(e))}}catch(e){}return[]}(e);t.length>0&&(r=function(e,t){let i=t.connectedRelays();if(!Array.from(e.relays).some(e=>i.map(e=>e.url).includes(e.url)))for(let t of i)e.addRelay(t);if(0===i.length)for(let i of t.relays.values())e.addRelay(i);return e}(r=new I(new Set(t),this),this.pool))}if(!(s="string"==typeof e?function(e){let t;if(e.match(v)){let[t,i,s]=e.split(":"),r={authors:[i],kinds:[parseInt(t)]};return s&&(r["#d"]=[s]),r}if(e.match(R))try{switch((t=h.uD.decode(e)).type){case"nevent":return{ids:[t.data.id]};case"note":return{ids:[t.data]};case"naddr":let i={authors:[t.data.pubkey],kinds:[t.data.kind]};return t.data.identifier&&(i["#d"]=[t.data.identifier]),i}}catch(t){console.error("Error decoding",e,t)}return{ids:[e]}}(e):e))throw Error(`Invalid filter: ${JSON.stringify(e)}`);return new Promise(e=>{let i=null,n=this.subscribe(s,{...t||{},closeOnEose:!0},r,!1);n.on("event",t=>{t.ndk=this,t.isReplaceable()?(!i||i.created_at<t.created_at)&&(i=t):e(t)}),n.on("eose",()=>{e(i)}),n.start()})}async fetchEvents(e,t,i){return new Promise(s=>{let r=new Map,n=this.subscribe(e,{...t||{},closeOnEose:!0},i,!1),a=e=>{let t=e.deduplicationKey(),i=r.get(t);if(i){var s;s=e,e=i.created_at>s.created_at?i:s}e.ndk=this,r.set(t,e)};n.on("event",a),n.on("event:dup",a),n.on("eose",()=>{s(new Set(r.values()))}),n.start()})}assertSigner(){if(!this.signer)throw this.emit("signer:required"),Error("Signer required")}getNip96(e){return new eD(e,this)}async nwc(e,t=2e3){let i=await eA.fromURI(this,e);return!1!==t&&await i.blockUntilReady(t),i}}}}]);